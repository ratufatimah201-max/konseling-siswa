<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>e-Counseling - SMAN 1 Dramaga</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --c-primary: #4f46e5;
            --c-primary-dark: #4338ca;
            --c-bg-app: #f3f4f6;
            --c-bg-card: #ffffff;
            --c-text-main: #1f2937;
            --c-text-muted: #6b7280;
            --c-text-on-primary: #ffffff;
            --c-border: #d1d5db;
            --c-bubble-sent-bg: #4f46e5;
            --c-bubble-sent-text: #ffffff;
            --c-bubble-received-bg: #e5e7eb;
            --c-bubble-received-text: #1f2937;
            --c-login-grad-from: #3b82f6;
            --c-login-grad-to: #6366f1;
        }
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--c-bg-app);
            color: var(--c-text-main);
            transition: background-color 0.3s, color 0.3s;
        }
        .fade-in { animation: fadeIn 0.5s ease-in-out; }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .modal-backdrop { background-color: rgba(0,0,0,0.5); }
        .bg-primary { background-color: var(--c-primary); }
        .text-primary { color: var(--c-primary); }
        .text-on-primary { color: var(--c-text-on-primary); }
        .hover\:bg-primary-dark:hover { background-color: var(--c-primary-dark); }
        .focus\:ring-primary:focus { --tw-ring-color: var(--c-primary); }
        .focus\:border-primary:focus { border-color: var(--c-primary); }
        .bg-card { background-color: var(--c-bg-card); }
        .text-main { color: var(--c-text-main); }
        .text-muted { color: var(--c-text-muted); }
        .border-main { border-color: var(--c-border); }
        .bubble-sent { background-color: var(--c-bubble-sent-bg); color: var(--c-bubble-sent-text); }
        .bubble-received { background-color: var(--c-bubble-received-bg); color: var(--c-bubble-received-text); }
        .login-gradient { background-image: linear-gradient(to bottom right, var(--c-login-grad-from), var(--c-login-grad-to)); }
        .notification-dot {
            position: absolute;
            top: -2px;
            right: -2px;
            width: 10px;
            height: 10px;
            background-color: #ef4444;
            border-radius: 50%;
            border: 2px solid var(--c-bg-card);
        }
    </style>
</head>
<body class="bg-card">

    <div id="app" class="max-w-7xl mx-auto min-h-screen transition-all duration-500">
        <!-- App content is rendered here by JavaScript -->
    </div>
    
    <div id="toast-notification" class="hidden fixed bottom-5 right-5 bg-green-500 text-white py-2 px-4 rounded-lg shadow-lg fade-in">
        <!-- Toast message here -->
    </div>
    
    <audio id="counseling-music" loop></audio>
    
    <script type="module">
        // Firebase Imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, query, where, doc, updateDoc, arrayUnion, serverTimestamp, orderBy, getDocs, writeBatch, deleteDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        let db, auth, app;
        let unsubscribeConsultations = null;
        let unsubscribeCounselors = null;
        let unsubscribeStudents = null;

        const translations = {
            app_title: { id: 'e-Counseling', en: 'e-Counseling' },
            app_subtitle: { id: 'Platform Konseling Siswa Digital', en: 'Digital Student Counseling Platform' },
            school_name: { id: 'SMAN 1 DRAMAGA', en: 'SMAN 1 DRAMAGA' },
            full_name: { id: 'Nama Lengkap', en: 'Full Name' },
            username: { id: 'Nama Pengguna', en: 'Username' },
            enter_your_name: { id: 'Masukkan nama Anda', en: 'Enter your name' },
            enter_username: { id: 'Masukkan nama pengguna', en: 'Enter username' },
            login_as_student: { id: 'Masuk sebagai Siswa', en: 'Login as Student' },
            login_as_counselor: { id: 'Masuk sebagai Konselor', en: 'Login as Counselor' },
            login_as_admin: { id: 'Masuk sebagai Admin', en: 'Login as Admin' },
            login_button: { id: 'Masuk', en: 'Login' },
            name_required: { id: 'Nama tidak boleh kosong.', en: 'Name cannot be empty.' },
            username_required: { id: 'Nama pengguna tidak boleh kosong.', en: 'Username cannot be empty.' },
            password: { id: 'Kata Sandi', en: 'Password' },
            initial_password: { id: 'Kata Sandi Awal', en: 'Initial Password'},
            enter_password: { id: 'Masukkan kata sandi', en: 'Enter password' },
            password_incorrect: { id: 'Nama pengguna atau kata sandi salah.', en: 'Incorrect username or password.' },
            role_student: { id: 'Siswa', en: 'Student' },
            role_counselor: { id: 'Konselor', en: 'Counselor' },
            role_admin: { id: 'Administrator', en: 'Administrator' },
            your_consultation_history: { id: 'Riwayat Konsultasi Anda', en: 'Your Consultation History' },
            create_new_consultation: { id: 'Buat Konsultasi Baru', en: 'Create New Consultation' },
            no_consultation_yet: { id: 'Belum Ada Konsultasi', en: 'No Consultation Yet' },
            no_counselor_yet: { id: 'Belum ada konselor terdaftar.', en: 'No counselors registered yet.' },
            no_student_yet: { id: 'Belum ada siswa terdaftar.', en: 'No students registered yet.' },
            no_consultation_desc: { id: 'Klik "Buat Konsultasi Baru" untuk memulai sesi dengan konselor.', en: 'Click "Create New Consultation" to start a session with a counselor.' },
            student_consultation_list: { id: 'Daftar Konsultasi Siswa', en: 'Student Consultation List' },
            consultations_for_you: { id: 'Konsultasi untuk Anda', en: 'Consultations for You' },
            your_consultation: { id: 'Konsultasi Anda', en: 'Your Consultation' },
            counselor: { id: 'Konselor', en: 'Counselor' },
            not_assigned: { id: 'Belum ditugaskan', en: 'Not assigned' },
            messages: { id: 'pesan', en: 'messages' },
            back_to_dashboard: { id: 'Kembali ke Dashboard', en: 'Back to Dashboard' },
            back_to_role_selection: { id: 'Kembali', en: 'Back'},
            topic: { id: 'Topik', en: 'Topic' },
            status_new: { id: 'Baru', en: 'New' },
            status_in_progress: { id: 'Dalam Proses', en: 'In Progress' },
            status_done: { id: 'Selesai', en: 'Done' },
            initial_problem_desc: { id: 'Deskripsi Masalah Awal:', en: 'Initial Problem Description:' },
            type_your_message: { id: 'Ketik pesan Anda...', en: 'Type your message...' },
            consultation_form_title: { id: 'Form Pengajuan Konsultasi', en: 'Consultation Request Form' },
            class: { id: 'Kelas', en: 'Class' },
            class_placeholder: { id: 'Contoh: XII IPA 1', en: 'Example: 12th Grade Science 1' },
            problem_category: { id: 'Kategori Masalah', en: 'Problem Category' },
            select_category: { id: 'Pilih Kategori', en: 'Select Category' },
            category_academic: { id: 'Akademik', en: 'Academic' },
            category_career: { id: 'Karir', en: 'Career' },
            category_pribadi_sosial: { id: 'Pribadi/Sosial', en: 'Personal/Social' },
            category_lainnya: { id: 'Lainnya', en: 'Other' },
            describe_your_problem: { id: 'Deskripsikan Masalah Anda', en: 'Describe Your Problem' },
            describe_your_problem_placeholder: { id: 'Ceritakan dengan singkat masalah yang sedang Anda hadapi...', en: 'Briefly describe the problem you are facing...' },
            choose_counselor: { id: 'Pilih Konselor', en: 'Choose Counselor' },
            select_counselor: { id: 'Pilih seorang konselor', en: 'Select a counselor' },
            send_request: { id: 'Kirim Pengajuan', en: 'Send Request' },
            all_consultations: { id: 'Semua Riwayat Konsultasi', en: 'All Consultation History' },
            notification: { id: 'Notifikasi', en: 'Notifications' },
            new_updates: { id: 'Anda memiliki pembaruan baru!', en: 'You have new updates!' },
            no_new_updates: { id: 'Tidak ada pembaruan baru.', en: 'No new updates.' },
            account_settings: { id: 'Pengaturan Akun', en: 'Account Settings' },
            change_password: { id: 'Ganti Kata Sandi', en: 'Change Password' },
            current_password: { id: 'Kata Sandi Saat Ini', en: 'Current Password' },
            new_password: { id: 'Kata Sandi Baru', en: 'New Password' },
            confirm_new_password: { id: 'Konfirmasi Kata Sandi Baru', en: 'Confirm New Password' },
            passwords_do_not_match: { id: 'Kata sandi baru tidak cocok.', en: 'New passwords do not match.' },
            password_changed_success: { id: 'Kata sandi berhasil diubah!', en: 'Password changed successfully!' },
            priority: { id: 'Prioritas', en: 'Priority' },
            priority_low: { id: 'Rendah', en: 'Low' },
            priority_normal: { id: 'Normal', en: 'Normal' },
            priority_high: { id: 'Tinggi', en: 'High' },
            admin_dashboard: { id: 'Dasbor Admin', en: 'Admin Dashboard' },
            manage_counselors: { id: 'Kelola Guru Konselor', en: 'Manage Counselors' },
            add_new_counselor: { id: 'Tambah Konselor Baru', en: 'Add New Counselor' },
            counselor_name: { id: 'Nama Konselor', en: 'Counselor Name' },
            specialty: { id: 'Spesialisasi (cth: Guru BK)', en: 'Specialty (e.g., School Counselor)' },
            add_counselor: { id: 'Tambah Konselor', en: 'Add Counselor' },
            existing_counselors: { id: 'Daftar Konselor Saat Ini', en: 'Current Counselor List' },
            manage_students: { id: 'Kelola Akun Siswa', en: 'Manage Student Accounts'},
            add_new_student: { id: 'Tambah Siswa Baru', en: 'Add New Student'},
            add_student: { id: 'Tambah Siswa', en: 'Add Student' },
            existing_students: { id: 'Daftar Siswa Saat Ini', en: 'Current Student List'},
            reset_password: { id: 'Reset Password', en: 'Reset Password'},
            delete: { id: 'Hapus', en: 'Delete'},
            confirm_action: { id: 'Konfirmasi Tindakan', en: 'Confirm Action'},
            yes_continue: { id: 'Ya, Lanjutkan', en: 'Yes, Continue'},
            no_cancel: { id: 'Tidak, Batalkan', en: 'No, Cancel'},
        };
        
        const themes = {
            default: { name: 'Bawaan', vars: { '--c-primary': '#4f46e5', '--c-primary-dark': '#4338ca', '--c-bg-app': '#f3f4f6', '--c-bg-card': '#ffffff', '--c-text-main': '#1f2937', '--c-text-muted': '#6b7280', '--c-text-on-primary': '#ffffff', '--c-border': '#d1d5db', '--c-bubble-sent-bg': '#4f46e5', '--c-bubble-sent-text': '#ffffff', '--c-bubble-received-bg': '#e5e7eb', '--c-bubble-received-text': '#1f2937', '--c-login-grad-from': '#3b82f6', '--c-login-grad-to': '#6366f1' }},
            tenang: { name: 'Tenang', vars: { '--c-primary': '#0d9488', '--c-primary-dark': '#0f766e', '--c-bg-app': '#f0fdfa', '--c-bg-card': '#ffffff', '--c-text-main': '#1f2937', '--c-text-muted': '#57534e', '--c-text-on-primary': '#ffffff', '--c-border': '#d1d5db', '--c-bubble-sent-bg': '#0d9488', '--c-bubble-sent-text': '#ffffff', '--c-bubble-received-bg': '#dcfce7', '--c-bubble-received-text': '#1f2937', '--c-login-grad-from': '#5eead4', '--c-login-grad-to': '#2dd4bf' }},
            fokus: { name: 'Fokus', vars: { '--c-primary': '#818cf8', '--c-primary-dark': '#6366f1', '--c-bg-app': '#111827', '--c-bg-card': '#1f2937', '--c-text-main': '#f9fafb', '--c-text-muted': '#9ca3af', '--c-text-on-primary': '#111827', '--c-border': '#374151', '--c-bubble-sent-bg': '#818cf8', '--c-bubble-sent-text': '#111827', '--c-bubble-received-bg': '#374151', '--c-bubble-received-text': '#f9fafb', '--c-login-grad-from': '#1e293b', '--c-login-grad-to': '#0f172a' }},
        };

        const musicTracks = [
            { id: 'none', name: 'Tanpa Musik', src: '' },
            { id: 'calm_piano', name: 'Piano Tenang', src: 'https://cdn.pixabay.com/download/audio/2022/10/19/audio_b2810a9fce.mp3' },
        ];

        function t(key) { return translations[key] ? (translations[key][state.currentLang] || translations[key]['id']) : key; }

        const state = {
            currentView: 'role_selection',
            currentUser: null,
            selectedKonsultasi: null,
            currentLang: 'id',
            currentTheme: 'default',
            isMusicPlaying: false,
            currentMusicTrack: 'none',
            counselors: [],
            students: [],
            konsultasiData: [],
            hasNewNotification: false,
            isAuthReady: false,
        };

        // === TEMPLATES / VIEWS ===
        function CommonSelectors() {
            return `
                <div class="flex items-center gap-2">
                    <label for="theme-select" class="text-sm text-muted"><i class="fas fa-palette"></i></label>
                    <select id="theme-select" onchange="window.setTheme(this.value)" class="border-main rounded-md text-sm py-1 bg-card text-main focus:ring-primary focus:border-primary">
                        ${Object.keys(themes).map(key => `<option value="${key}" ${state.currentTheme === key ? 'selected' : ''}>${themes[key].name}</option>`).join('')}
                    </select>
                     <label for="lang-select" class="text-sm text-muted"><i class="fas fa-globe"></i></label>
                    <select id="lang-select" onchange="window.setLanguage(this.value)" class="border-main rounded-md text-sm py-1 bg-card text-main focus:ring-primary focus:border-primary">
                        <option value="id" ${state.currentLang === 'id' ? 'selected' : ''}>ID</option>
                        <option value="en" ${state.currentLang === 'en' ? 'selected' : ''}>EN</option>
                    </select>
                </div>
            `;
        }
        
        function RoleSelectionView() {
             return `
                <div class="min-h-screen flex items-center justify-center login-gradient px-4 fade-in">
                    <div class="w-full max-w-md bg-card rounded-2xl shadow-2xl p-8 space-y-8 relative">
                        <div class="absolute top-4 right-4">${CommonSelectors()}</div>
                        <div class="text-center pt-12">
                            <i class="fas fa-hands-helping text-5xl text-primary"></i>
                            <h1 class="text-3xl font-bold text-main mt-4">${t('app_title')}</h1>
                            <p class="font-semibold text-muted">${t('school_name')}</p>
                            <p class="text-muted text-sm">${t('app_subtitle')}</p>
                        </div>
                        <div class="space-y-4">
                             <button onclick="window.navigateTo('login_siswa')" class="w-full py-3 px-4 bg-primary text-on-primary font-semibold rounded-lg shadow-md hover:bg-primary-dark focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary transition-transform transform hover:scale-105">
                                <i class="fas fa-user-graduate mr-2"></i> ${t('login_as_student')}
                            </button>
                            <button onclick="window.navigateTo('login_konselor')" class="w-full py-3 px-4 bg-gray-700 text-white font-semibold rounded-lg shadow-md hover:bg-gray-800 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-600 transition-transform transform hover:scale-105">
                                <i class="fas fa-user-tie mr-2"></i> ${t('login_as_counselor')}
                            </button>
                            <button onclick="window.navigateTo('login_admin')" class="w-full py-3 px-4 bg-red-600 text-white font-semibold rounded-lg shadow-md hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500 transition-transform transform hover:scale-105">
                                <i class="fas fa-user-shield mr-2"></i> ${t('login_as_admin')}
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }

        function LoginSiswaView() {
            return `
                <div class="min-h-screen flex items-center justify-center login-gradient px-4 fade-in">
                    <div class="w-full max-w-md bg-card rounded-2xl shadow-2xl p-8 space-y-6 relative">
                         <div class="absolute top-4 left-4">
                            <button onclick="window.navigateTo('role_selection')" class="text-muted hover:text-primary font-semibold"><i class="fas fa-arrow-left mr-2"></i>${t('back_to_role_selection')}</button>
                        </div>
                        <div class="text-center pt-12">
                            <i class="fas fa-user-graduate text-5xl text-primary"></i>
                            <h1 class="text-2xl font-bold text-main mt-4">${t('login_as_student')}</h1>
                        </div>
                        <form onsubmit="window.login(event, 'siswa')" class="space-y-4">
                            <div>
                                <label for="name" class="block text-sm font-medium text-main">${t('username')}</label>
                                <input id="name" type="text" class="w-full px-4 py-2 mt-1 border border-main rounded-lg focus:ring-primary focus:border-primary bg-card text-main" placeholder="${t('enter_username')}">
                            </div>
                            <div>
                                <label for="student-password" class="block text-sm font-medium text-main">${t('password')}</label>
                                <div class="relative mt-1">
                                    <input id="student-password" type="password" class="w-full px-4 py-2 border border-main rounded-lg focus:ring-primary focus:border-primary bg-card text-main" placeholder="${t('enter_password')}">
                                    <button type="button" onclick="window.togglePasswordVisibility('student-password', 'student-pw-icon')" class="absolute inset-y-0 right-0 px-3 flex items-center text-muted">
                                        <i id="student-pw-icon" class="fas fa-eye"></i>
                                    </button>
                                </div>
                            </div>
                            <div class="pt-2">
                                <button type="submit" class="w-full py-3 px-4 bg-primary text-on-primary font-semibold rounded-lg shadow-md hover:bg-primary-dark focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary">
                                    ${t('login_button')}
                                </button>
                            </div>
                        </form>
                        <p id="login-error" class="text-red-500 text-sm text-center"></p>
                    </div>
                </div>
            `;
        }
        
        function LoginKonselorView() {
             return `
                <div class="min-h-screen flex items-center justify-center login-gradient px-4 fade-in">
                    <div class="w-full max-w-md bg-card rounded-2xl shadow-2xl p-8 space-y-6 relative">
                        <div class="absolute top-4 left-4">
                            <button onclick="window.navigateTo('role_selection')" class="text-muted hover:text-primary font-semibold"><i class="fas fa-arrow-left mr-2"></i>${t('back_to_role_selection')}</button>
                        </div>
                        <div class="text-center pt-12">
                            <i class="fas fa-user-tie text-5xl text-primary"></i>
                             <h1 class="text-2xl font-bold text-main mt-4">${t('login_as_counselor')}</h1>
                        </div>
                        <form onsubmit="window.login(event, 'konselor')" class="space-y-4">
                             <div>
                                <label for="counselor-select-login" class="block text-sm font-medium text-main">${t('full_name')}</label>
                                <select id="counselor-select-login" class="w-full px-4 py-2 mt-1 border border-main rounded-lg focus:ring-primary focus:border-primary bg-card text-main">
                                    <option value="">${t('select_counselor')}</option>
                                    ${state.counselors.map(c => `<option value="${c.name}">${c.name}</option>`).join('')}
                                </select>
                            </div>
                            <div>
                                <label for="counselor-password" class="block text-sm font-medium text-main">${t('password')}</label>
                                <div class="relative mt-1">
                                    <input id="counselor-password" type="password" class="w-full px-4 py-2 border border-main rounded-lg focus:ring-primary focus:border-primary bg-card text-main" placeholder="${t('enter_password')}">
                                    <button type="button" onclick="window.togglePasswordVisibility('counselor-password', 'counselor-pw-icon')" class="absolute inset-y-0 right-0 px-3 flex items-center text-muted">
                                        <i id="counselor-pw-icon" class="fas fa-eye"></i>
                                    </button>
                                </div>
                            </div>
                             <div class="pt-2">
                                <button type="submit" class="w-full py-3 px-4 bg-primary text-on-primary font-semibold rounded-lg shadow-md hover:bg-primary-dark focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary">
                                    ${t('login_button')}
                                </button>
                            </div>
                        </form>
                        <p id="login-error" class="text-red-500 text-sm text-center"></p>
                    </div>
                </div>
            `;
        }

        function LoginAdminView() {
            return `
                <div class="min-h-screen flex items-center justify-center login-gradient px-4 fade-in">
                    <div class="w-full max-w-md bg-card rounded-2xl shadow-2xl p-8 space-y-6 relative">
                         <div class="absolute top-4 left-4">
                            <button onclick="window.navigateTo('role_selection')" class="text-muted hover:text-primary font-semibold"><i class="fas fa-arrow-left mr-2"></i>${t('back_to_role_selection')}</button>
                        </div>
                        <div class="text-center pt-12">
                            <i class="fas fa-user-shield text-5xl text-primary"></i>
                            <h1 class="text-2xl font-bold text-main mt-4">${t('login_as_admin')}</h1>
                        </div>
                        <form onsubmit="window.login(event, 'admin')" class="space-y-4">
                            <div>
                                <label for="admin-username" class="block text-sm font-medium text-main">${t('username')}</label>
                                <input id="admin-username" type="text" class="w-full px-4 py-2 mt-1 border border-main rounded-lg focus:ring-primary focus:border-primary bg-card text-main" placeholder="${t('enter_username')}">
                            </div>
                            <div>
                                <label for="admin-password" class="block text-sm font-medium text-main">${t('password')}</label>
                                <div class="relative mt-1">
                                    <input id="admin-password" type="password" class="w-full px-4 py-2 border border-main rounded-lg focus:ring-primary focus:border-primary bg-card text-main" placeholder="${t('enter_password')}">
                                    <button type="button" onclick="window.togglePasswordVisibility('admin-password', 'admin-pw-icon')" class="absolute inset-y-0 right-0 px-3 flex items-center text-muted">
                                        <i id="admin-pw-icon" class="fas fa-eye"></i>
                                    </button>
                                </div>
                            </div>
                            <div class="pt-2">
                                <button type="submit" class="w-full py-3 px-4 bg-primary text-on-primary font-semibold rounded-lg shadow-md hover:bg-primary-dark focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary">
                                    ${t('login_button')}
                                </button>
                            </div>
                        </form>
                        <p id="login-error" class="text-red-500 text-sm text-center"></p>
                    </div>
                </div>
            `;
        }

        function DashboardAdminView() {
            const content = `
                <div class="grid lg:grid-cols-3 gap-8">
                    <div class="lg:col-span-1 space-y-8">
                         <div class="bg-card p-6 rounded-lg shadow">
                            <h3 class="text-lg font-semibold text-main mb-4">${t('manage_counselors')}</h3>
                            <form onsubmit="window.addCounselor(event)" class="space-y-4">
                                <div><label for="counselor-name" class="block text-sm font-medium text-main">${t('counselor_name')}</label><input id="counselor-name" type="text" required class="w-full px-4 py-2 mt-1 border border-main rounded-lg focus:ring-primary focus:border-primary bg-card text-main"></div>
                                <div><label for="counselor-specialty" class="block text-sm font-medium text-main">${t('specialty')}</label><input id="counselor-specialty" type="text" required class="w-full px-4 py-2 mt-1 border border-main rounded-lg focus:ring-primary focus:border-primary bg-card text-main"></div>
                                <div><label for="counselor-password" class="block text-sm font-medium text-main">${t('password')}</label><input id="counselor-password" type="text" required class="w-full px-4 py-2 mt-1 border border-main rounded-lg focus:ring-primary focus:border-primary bg-card text-main"></div>
                                <button type="submit" class="w-full py-2 px-4 bg-primary text-on-primary font-semibold rounded-lg shadow-md hover:bg-primary-dark">${t('add_counselor')}</button>
                            </form>
                             <h3 class="text-lg font-semibold text-main mt-6 mb-4">${t('existing_counselors')}</h3>
                            <ul class="space-y-3 max-h-48 overflow-y-auto">${state.counselors.map(c => `<li class="p-3 bg-gray-50 rounded-md border border-main"><div class="flex justify-between items-start"><div><p class="font-semibold text-main">${c.name}</p><p class="text-sm text-muted">${c.specialty}</p></div><div class="flex flex-col gap-2 items-end"><button onclick="window.resetCounselorPassword('${c.id}', '${c.name}')" class="px-2 py-1 text-xs font-medium text-white bg-yellow-500 rounded hover:bg-yellow-600">${t('reset_password')}</button><button onclick="window.deleteCounselor('${c.id}', '${c.name}')" class="px-2 py-1 text-xs font-medium text-white bg-red-500 rounded hover:bg-red-600">${t('delete')}</button></div></div></li>`).join('') || `<p class="text-muted text-sm">${t('no_counselor_yet')}</p>`}</ul>
                        </div>
                        <div class="bg-card p-6 rounded-lg shadow">
                            <h3 class="text-lg font-semibold text-main mb-4">${t('manage_students')}</h3>
                             <form onsubmit="window.addStudent(event)" class="space-y-4">
                                <div><label for="student-fullname" class="block text-sm font-medium text-main">${t('full_name')}</label><input id="student-fullname" type="text" required class="w-full px-4 py-2 mt-1 border border-main rounded-lg focus:ring-primary focus:border-primary bg-card text-main"></div>
                                <div><label for="student-username" class="block text-sm font-medium text-main">${t('username')}</label><input id="student-username" type="text" required class="w-full px-4 py-2 mt-1 border border-main rounded-lg focus:ring-primary focus:border-primary bg-card text-main"></div>
                                <div><label for="student-initial-password" class="block text-sm font-medium text-main">${t('initial_password')}</label><input id="student-initial-password" type="text" required class="w-full px-4 py-2 mt-1 border border-main rounded-lg focus:ring-primary focus:border-primary bg-card text-main"></div>
                                <div><label for="student-class" class="block text-sm font-medium text-main">${t('class')}</label><input id="student-class" type="text" required class="w-full px-4 py-2 mt-1 border border-main rounded-lg focus:ring-primary focus:border-primary bg-card text-main"></div>
                                <button type="submit" class="w-full py-2 px-4 bg-primary text-on-primary font-semibold rounded-lg shadow-md hover:bg-primary-dark">${t('add_student')}</button>
                            </form>
                             <h3 class="text-lg font-semibold text-main mt-6 mb-4">${t('existing_students')}</h3>
                            <ul class="space-y-3 max-h-48 overflow-y-auto">${state.students.map(s => `<li class="p-3 bg-gray-50 rounded-md border border-main"><div class="flex justify-between items-start"><div><p class="font-semibold text-main">${s.fullName}</p><p class="text-sm text-muted">${s.username} | ${s.kelas}</p></div><div class="flex gap-2"><button onclick="window.resetStudentPassword('${s.id}', '${s.fullName}')" class="px-2 py-1 text-xs font-medium text-white bg-yellow-500 rounded hover:bg-yellow-600">${t('reset_password')}</button><button onclick="window.deleteStudent('${s.id}', '${s.fullName}')" class="px-2 py-1 text-xs font-medium text-white bg-red-500 rounded hover:bg-red-600">${t('delete')}</button></div></div></li>`).join('') || `<p class="text-muted text-sm">${t('no_student_yet')}</p>`}</ul>
                        </div>
                    </div>
                    <div class="lg:col-span-2 bg-card p-6 rounded-lg shadow">
                        <h3 class="text-lg font-semibold text-main mb-4">${t('all_consultations')}</h3>
                        <div class="space-y-4 max-h-[85vh] overflow-y-auto">
                            ${state.konsultasiData.length > 0 ? state.konsultasiData.map(KonsultasiCard).join('') : `<p class="text-muted">${t('no_consultation_yet')}</p>`}
                        </div>
                    </div>
                </div>
            `;
            return MainLayout(content);
        }

        function MainLayout(content) {
            const roleKey = `role_${state.currentUser.role}`;
            const roleText = t(roleKey);
            return `
                <div class="min-h-screen">
                    <header class="bg-card shadow-md sticky top-0 z-10">
                        <nav class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                            <div class="flex items-center justify-between h-16">
                                <div class="flex items-center">
                                    <i class="fas fa-hands-helping text-3xl text-primary"></i>
                                    <div class="ml-2">
                                        <span class="font-bold text-xl text-main">${t('app_title')}</span>
                                        <span class="text-xs text-muted block">${t('school_name')}</span>
                                    </div>
                                </div>
                                <div class="flex items-center gap-4">
                                     ${CommonSelectors()}
                                     <div class="relative">
                                        <button onclick="window.showNotification()" class="p-2 rounded-full text-muted hover:text-primary focus:outline-none">
                                            <i class="fas fa-bell fa-lg"></i>
                                            ${state.hasNewNotification ? '<span class="notification-dot"></span>' : ''}
                                        </button>
                                     </div>
                                    <div class="text-right">
                                        <p class="font-semibold text-main">${state.currentUser.fullName || state.currentUser.name}</p>
                                        <p class="text-sm text-muted">${roleText}</p>
                                    </div>
                                    ${state.currentUser.role === 'siswa' ? `<button onclick="window.openModal('changePassword')" class="ml-2 p-2 rounded-full text-muted hover:text-primary"><i class="fas fa-cog"></i></button>` : ''}
                                    <button onclick="window.logout()" class="ml-2 p-2 rounded-full text-muted hover:bg-red-100 hover:text-red-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500">
                                        <i class="fas fa-sign-out-alt fa-lg"></i>
                                    </button>
                                </div>
                            </div>
                        </nav>
                    </header>
                    <main class="p-4 sm:p-6 lg:p-8 fade-in">
                        ${content}
                    </main>
                </div>
                ${ModalWrapper()}
            `;
        }
        
        function getStatusBadge(status) {
             const statusText = { 'Baru': t('status_new'), 'Dalam Proses': t('status_in_progress'), 'Selesai': t('status_done') }[status] || status;
            switch (status) {
                case 'Baru': return `<span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-blue-100 text-blue-800">${statusText}</span>`;
                case 'Dalam Proses': return `<span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-yellow-100 text-yellow-800">${statusText}</span>`;
                case 'Selesai': return `<span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-green-100 text-green-800">${statusText}</span>`;
                default: return `<span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-gray-100 text-gray-800">${statusText}</span>`;
            }
        }
        
        function getPriorityBadge(priority) {
            if (priority === 'Tinggi') {
                return `<span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-red-100 text-red-800">${t('priority_high')}</span>`;
            } else if (priority === 'Normal') {
                return `<span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-yellow-100 text-yellow-800">${t('priority_normal')}</span>`;
            } else if (priority === 'Rendah') {
                return `<span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-gray-100 text-gray-800">${t('priority_low')}</span>`;
            }
            return '';
        }
        
        function KonsultasiCard(konsultasi) {
            const isCounselor = state.currentUser.role === 'konselor';
            const isAdmin = state.currentUser.role === 'admin';
            const categoryKey = `category_${(konsultasi.kategori || '').toLowerCase().replace(/[\/ ]/g, '_')}`;
            const translatedCategory = t(categoryKey);
            
            return `
                <div class="bg-card rounded-xl shadow-lg p-5 hover:shadow-xl transition-shadow duration-300 cursor-pointer" onclick="window.openChat('${konsultasi.id}')">
                    <div class="flex justify-between items-start">
                        <div>
                            <p class="text-sm text-muted">${translatedCategory}</p>
                            <h3 class="text-lg font-bold text-main">${isCounselor || isAdmin ? konsultasi.siswaName : t('your_consultation')}</h3>
                            <p class="text-sm text-muted">${isCounselor || isAdmin ? konsultasi.kelas : `ID: #${(konsultasi.id || '').substring(0,5)}`}</p>
                        </div>
                        <div class="flex flex-col items-end gap-2">
                             ${getStatusBadge(konsultasi.status)}
                             ${getPriorityBadge(konsultasi.priority)}
                        </div>
                    </div>
                    <p class="mt-3 text-muted text-sm line-clamp-2">${konsultasi.deskripsi}</p>
                    <div class="mt-4 pt-4 border-t border-main flex justify-between items-center text-xs text-muted">
                        <span>${t('counselor')}: ${konsultasi.konselorName || t('not_assigned')}</span>
                        <span class="flex items-center"><i class="far fa-comments mr-1"></i> ${(konsultasi.chatHistory || []).length} ${t('messages')}</span>
                    </div>
                </div>
            `;
        }

        function DashboardSiswaView() {
            const myKonsultasi = state.konsultasiData;
            const content = `
                <div class="flex flex-wrap justify-between items-center gap-4 mb-6">
                    <h2 class="text-2xl font-bold text-main">${t('your_consultation_history')}</h2>
                    <button onclick="window.openModal('formKonsultasi')" class="bg-primary text-on-primary font-bold py-2 px-4 rounded-lg shadow-md hover:bg-primary-dark transition-transform transform hover:scale-105">
                        <i class="fas fa-plus mr-2"></i>${t('create_new_consultation')}
                    </button>
                </div>
                ${myKonsultasi.length > 0 ? `<div class="grid md:grid-cols-2 lg:grid-cols-3 gap-6">${myKonsultasi.map(KonsultasiCard).join('')}</div>` : `<div class="text-center py-16 bg-card rounded-lg shadow"><i class="fas fa-folder-open text-5xl text-gray-300"></i><h3 class="mt-4 text-xl font-semibold text-main">${t('no_consultation_yet')}</h3><p class="text-muted mt-1">${t('no_consultation_desc')}</p></div>`}
            `;
            return MainLayout(content);
        }

        function DashboardKonselorView() {
            const assignedConsultations = state.konsultasiData;
             const content = `
                <h2 class="text-2xl font-bold text-main mb-6">${t('consultations_for_you')}</h2>
                ${assignedConsultations.length > 0 ? `
                    <div class="grid md:grid-cols-2 lg:grid-cols-3 gap-6">
                        ${assignedConsultations.map(KonsultasiCard).join('')}
                    </div>
                ` : `
                    <div class="text-center py-16 bg-card rounded-lg shadow">
                        <i class="fas fa-inbox text-5xl text-gray-300"></i>
                        <h3 class="mt-4 text-xl font-semibold text-main">Belum ada konsultasi untuk Anda</h3>
                        <p class="text-muted mt-1">Saat siswa memilih Anda sebagai konselor, sesi akan muncul di sini.</p>
                    </div>
                `}
            `;
            return MainLayout(content);
        }
        
        function ChatView(k) {
            const isCounselor = state.currentUser.role === 'konselor';
            const isAdmin = state.currentUser.role === 'admin';
            const categoryKey = `category_${(k.kategori || '').toLowerCase().replace(/[\/ ]/g, '_')}`;
            const translatedCategory = t(categoryKey);

            let priorityDisplay;
            if (isCounselor) {
                priorityDisplay = `
                    <div class="flex items-center gap-2">
                        <label class="text-sm font-medium text-main">${t('priority')}:</label>
                        <select onchange="window.updatePriority('${k.id}', this.value)" class="rounded-lg border-main bg-card text-main focus:ring-primary focus:border-primary text-sm">
                            <option value="Rendah" ${k.priority === 'Rendah' ? 'selected' : ''}>${t('priority_low')}</option>
                            <option value="Normal" ${k.priority === 'Normal' || !k.priority ? 'selected' : ''}>${t('priority_normal')}</option>
                            <option value="Tinggi" ${k.priority === 'Tinggi' ? 'selected' : ''}>${t('priority_high')}</option>
                        </select>
                    </div>
                `;
            } else {
                priorityDisplay = getPriorityBadge(k.priority);
            }
            
             return MainLayout(`
                <div>
                    <button onclick="window.backToDashboard()" class="mb-4 text-primary font-semibold hover:underline">
                        <i class="fas fa-arrow-left mr-2"></i>${t('back_to_dashboard')}
                    </button>
                    <div class="bg-card rounded-2xl shadow-xl overflow-hidden">
                        <div class="p-4 border-b border-main flex flex-wrap gap-4 justify-between items-center">
                            <div>
                                <h3 class="font-bold text-lg text-main">${k.siswaName} (${k.kelas})</h3>
                                <p class="text-sm text-muted">${t('topic')}: ${translatedCategory}</p>
                            </div>
                            <div class="flex items-center gap-4">
                                ${priorityDisplay}
                                ${isCounselor || isAdmin ? `<select onchange="window.updateStatus('${k.id}', this.value)" class="rounded-lg border-main bg-card text-main focus:ring-primary focus:border-primary text-sm">
                                    <option value="Baru" ${k.status === 'Baru' ? 'selected' : ''}>${t('status_new')}</option>
                                    <option value="Dalam Proses" ${k.status === 'Dalam Proses' ? 'selected' : ''}>${t('status_in_progress')}</option>
                                    <option value="Selesai" ${k.status === 'Selesai' ? 'selected' : ''}>${t('status_done')}</option>
                                </select>` : getStatusBadge(k.status)}
                            </div>
                        </div>
                        <div class="p-4 border-b border-main"><h4 class="font-semibold mb-2 text-main">${t('initial_problem_desc')}</h4><p class="text-sm bg-yellow-50 text-yellow-900 p-3 rounded-lg">${k.deskripsi}</p></div>
                        <div id="chat-box" class="p-4 h-96 overflow-y-auto space-y-4 flex flex-col">${(k.chatHistory || []).map(chat => `<div class="chat ${chat.sender === (state.currentUser.fullName || state.currentUser.name) ? 'chat-end' : 'chat-start'}"><div class="chat-header text-xs text-muted mb-1">${chat.sender}</div><div class="chat-bubble ${chat.sender === (state.currentUser.fullName || state.currentUser.name) ? 'bubble-sent' : 'bubble-received'}">${chat.text}</div></div>`).join('')}</div>
                        ${isAdmin ? '' : `<div class="p-4 border-t border-main"><form onsubmit="window.sendMessage(event, '${k.id}')"><div class="flex items-center gap-2"><input id="chat-input" type="text" class="w-full px-4 py-2 border border-main rounded-full focus:ring-primary focus:border-primary bg-card text-main" placeholder="${t('type_your_message')}"><button type="submit" class="bg-primary text-on-primary rounded-full p-3 hover:bg-primary-dark transition"><i class="fas fa-paper-plane"></i></button></div></form></div>`}
                    </div>
                </div>
            `);
        }
        
        function ModalWrapper() { 
            return `<div id="modal-container" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4 modal-backdrop"><div id="modal-content" class="bg-card rounded-2xl shadow-2xl w-full max-w-lg relative fade-in"></div></div>`;
        }

        function FormKonsultasiModal() {
            return `
                <button onclick="window.closeModal()" class="absolute top-4 right-4 text-muted hover:text-main"><i class="fas fa-times fa-lg"></i></button>
                <form onsubmit="window.submitKonsultasi(event)" class="p-8">
                    <h2 class="text-2xl font-bold mb-6 text-center text-main">${t('consultation_form_title')}</h2>
                    <div class="space-y-4">
                        <div><label for="kelas" class="block text-sm font-medium text-main">${t('class')}</label><input id="kelas" type="text" value="${state.currentUser.kelas || ''}" required class="w-full px-4 py-2 mt-1 border border-main rounded-lg focus:ring-primary focus:border-primary bg-card text-main" placeholder="${t('class_placeholder')}"></div>
                        <div><label for="kategori" class="block text-sm font-medium text-main">${t('problem_category')}</label><select id="kategori" required class="w-full px-4 py-2 mt-1 border border-main rounded-lg focus:ring-primary focus:border-primary bg-card text-main"><option value="">${t('select_category')}</option><option value="Akademik">${t('category_academic')}</option><option value="Karir">${t('category_career')}</option><option value="Pribadi/Sosial">${t('category_pribadi_sosial')}</option><option value="Lainnya">${t('category_lainnya')}</option></select></div>
                        <div>
                            <label for="konselor" class="block text-sm font-medium text-main">${t('choose_counselor')}</label>
                            <select id="konselor" required class="w-full px-4 py-2 mt-1 border border-main rounded-lg focus:ring-primary focus:border-primary bg-card text-main">
                                <option value="">${t('select_counselor')}</option>
                                ${state.counselors.map(c => `<option value="${c.name}">${c.name} (${c.specialty})</option>`).join('')}
                            </select>
                        </div>
                        <div><label for="deskripsi" class="block text-sm font-medium text-main">${t('describe_your_problem')}</label><textarea id="deskripsi" rows="5" required class="w-full px-4 py-2 mt-1 border border-main rounded-lg focus:ring-primary focus:border-primary bg-card text-main" placeholder="${t('describe_your_problem_placeholder')}"></textarea></div>
                        <div class="pt-4"><button type="submit" class="w-full py-3 px-4 bg-primary text-on-primary font-semibold rounded-lg shadow-md hover:bg-primary-dark focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary">${t('send_request')}</button></div>
                    </div>
                </form>`;
        }
        
        function ChangePasswordModal() {
            return `
                <button onclick="window.closeModal()" class="absolute top-4 right-4 text-muted hover:text-main"><i class="fas fa-times fa-lg"></i></button>
                <form onsubmit="window.changePassword(event)" class="p-8">
                    <h2 class="text-2xl font-bold mb-6 text-center text-main">${t('change_password')}</h2>
                    <div class="space-y-4">
                        <div><label for="current-password" class="block text-sm font-medium text-main">${t('current_password')}</label><input id="current-password" type="password" required class="w-full px-4 py-2 mt-1 border border-main rounded-lg focus:ring-primary focus:border-primary bg-card text-main"></div>
                        <div><label for="new-password" class="block text-sm font-medium text-main">${t('new_password')}</label><input id="new-password" type="password" required class="w-full px-4 py-2 mt-1 border border-main rounded-lg focus:ring-primary focus:border-primary bg-card text-main"></div>
                        <div><label for="confirm-password" class="block text-sm font-medium text-main">${t('confirm_new_password')}</label><input id="confirm-password" type="password" required class="w-full px-4 py-2 mt-1 border border-main rounded-lg focus:ring-primary focus:border-primary bg-card text-main"></div>
                        <div class="pt-4"><button type="submit" class="w-full py-3 px-4 bg-primary text-on-primary font-semibold rounded-lg shadow-md hover:bg-primary-dark">${t('change_password')}</button></div>
                    </div>
                    <p id="password-error" class="text-red-500 text-sm text-center mt-4"></p>
                </form>
            `;
        }

        function ConfirmationModal(message) {
            return `
                <div class="p-8 text-center">
                    <i class="fas fa-exclamation-triangle text-4xl text-yellow-400 mb-4"></i>
                    <h3 class="text-lg font-semibold text-main mb-2">${t('confirm_action')}</h3>
                    <p class="text-main mb-6">${message}</p>
                    <div class="flex justify-center gap-4">
                        <button id="confirm-no-btn" onclick="window.closeModal()" class="px-6 py-2 rounded-lg bg-gray-200 hover:bg-gray-300 text-main font-semibold">${t('no_cancel')}</button>
                        <button id="confirm-yes-btn" class="px-6 py-2 rounded-lg bg-red-600 hover:bg-red-700 text-white font-semibold">${t('yes_continue')}</button>
                    </div>
                </div>
            `;
        }
        
        // === CONTROLLERS / LOGIC ===

        function render() {
             const app = document.getElementById('app');
             document.title = `${t('app_title')} - SMAN 1 Dramaga`;

             if (!state.isAuthReady && state.currentView !== 'role_selection' && !state.currentView.startsWith('login')) {
                // Can show a global loader here
                return;
             }

             switch(state.currentView) {
                case 'role_selection': app.innerHTML = RoleSelectionView(); break;
                case 'login_siswa': app.innerHTML = LoginSiswaView(); break;
                case 'login_konselor': app.innerHTML = LoginKonselorView(); break;
                case 'login_admin': app.innerHTML = LoginAdminView(); break;
                case 'dashboard_siswa': app.innerHTML = DashboardSiswaView(); break;
                case 'dashboard_konselor': app.innerHTML = DashboardKonselorView(); break;
                case 'dashboard_admin': app.innerHTML = DashboardAdminView(); break;
                case 'chat':
                    const k = state.konsultasiData.find(c => c.id === state.selectedKonsultasi);
                    if (k) {
                        app.innerHTML = ChatView(k);
                        setTimeout(() => { const chatBox = document.getElementById('chat-box'); if(chatBox) chatBox.scrollTop = chatBox.scrollHeight; }, 0);
                    } else {
                        backToDashboard();
                    }
                    break;
                default: app.innerHTML = RoleSelectionView();
            }
        }
        
        function showNotification() {
            const message = state.hasNewNotification ? t('new_updates') : t('no_new_updates');
            showToast(message);
            if (state.hasNewNotification) {
                state.hasNewNotification = false;
                render();
            }
        }

        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast-notification');
            toast.textContent = message;
            toast.classList.remove('hidden', 'bg-green-500', 'bg-red-500');
            toast.classList.add(type === 'success' ? 'bg-green-500' : 'bg-red-500');
            setTimeout(() => {
                toast.classList.add('hidden');
            }, 3000);
        }

        async function login(event, role) {
            event.preventDefault();
            const errorEl = document.getElementById('login-error');
            errorEl.textContent = '';
            
            if (role === 'siswa') {
                const nameInput = document.getElementById('name');
                const passwordInput = document.getElementById('student-password');
                const username = nameInput.value.trim();
                const password = passwordInput.value;
                if (!username || !password) { errorEl.textContent = t('username_required'); return; }

                const student = state.students.find(s => s.username === username);
                if (student && student.password === password) {
                    state.currentUser = { ...student, role: 'siswa' };
                    state.currentView = 'dashboard_siswa';
                } else {
                    errorEl.textContent = t('password_incorrect'); return;
                }
            } else if (role === 'konselor') {
                const nameSelect = document.getElementById('counselor-select-login');
                const passwordInput = document.getElementById('counselor-password');
                const name = nameSelect.value;
                const password = passwordInput.value;
                 if (!name) { errorEl.textContent = t('name_required'); return; }

                const counselor = state.counselors.find(c => c.name === name);
                if (counselor && counselor.password === password) {
                    state.currentUser = { ...counselor, role: 'konselor' };
                    state.currentView = 'dashboard_konselor';
                } else {
                    errorEl.textContent = t('password_incorrect'); return;
                }
            } else if (role === 'admin') {
                const usernameInput = document.getElementById('admin-username');
                const passwordInput = document.getElementById('admin-password');
                const username = usernameInput.value.trim();
                const password = passwordInput.value;
                if (!username) { errorEl.textContent = t('username_required'); return; }
                if (username.toLowerCase() !== 'admin' || password !== 'admin123') {
                    errorEl.textContent = t('password_incorrect'); return;
                }
                state.currentUser = { name: 'Admin', role: 'admin' };
                state.currentView = 'dashboard_admin';
            }
            setupRealtimeListeners();
            render();
        }
        
        async function changePassword(event) {
            event.preventDefault();
            const errorEl = document.getElementById('password-error');
            errorEl.textContent = '';
            const currentPassword = document.getElementById('current-password').value;
            const newPassword = document.getElementById('new-password').value;
            const confirmPassword = document.getElementById('confirm-password').value;
            
            if (!newPassword || newPassword.length < 6) {
                errorEl.textContent = 'Kata sandi baru minimal 6 karakter.'; return;
            }
            if (newPassword !== confirmPassword) {
                errorEl.textContent = t('passwords_do_not_match'); return;
            }
            if (state.currentUser.password !== currentPassword) {
                errorEl.textContent = t('password_incorrect'); return;
            }
            
            try {
                const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
                const studentRef = doc(db, "artifacts", appId, "public/data/students", state.currentUser.id);
                await updateDoc(studentRef, { password: newPassword });
                
                showToast(t('password_changed_success'));
                closeModal();
            } catch (error) {
                console.error("Error changing password: ", error);
                errorEl.textContent = 'Gagal mengubah kata sandi.';
            }
        }
        
        async function updatePriority(konsultasiId, newPriority) {
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
            const docRef = doc(db, "artifacts", appId, "public/data/konsultasi", konsultasiId);
            await updateDoc(docRef, { priority: newPriority });
        }

        async function addCounselor(event) {
            event.preventDefault();
            const nameInput = document.getElementById('counselor-name');
            const specialtyInput = document.getElementById('counselor-specialty');
            const passwordInput = document.getElementById('counselor-password');
            const newCounselor = {
                name: nameInput.value.trim(),
                specialty: specialtyInput.value.trim(),
                password: passwordInput.value.trim(),
                createdAt: serverTimestamp()
            };
            if (!newCounselor.name || !newCounselor.specialty || !newCounselor.password) return;
            try {
                const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
                const colRef = collection(db, "artifacts", appId, "public/data/counselors");
                await addDoc(colRef, newCounselor);
                nameInput.value = '';
                specialtyInput.value = '';
                passwordInput.value = '';
                showToast('Konselor berhasil ditambahkan!');
            } catch(error) {
                console.error("Error adding counselor:", error);
                showToast('Gagal menambahkan konselor.', 'error');
            }
        }
        
        async function addStudent(event) {
            event.preventDefault();
            const fullNameInput = document.getElementById('student-fullname');
            const usernameInput = document.getElementById('student-username');
            const passwordInput = document.getElementById('student-initial-password');
            const classInput = document.getElementById('student-class');
            
            const newStudent = {
                fullName: fullNameInput.value.trim(),
                username: usernameInput.value.trim(),
                password: passwordInput.value.trim(),
                kelas: classInput.value.trim(),
            };

            if (!newStudent.fullName || !newStudent.username || !newStudent.password || !newStudent.kelas) {
                showToast('Semua kolom harus diisi.', 'error');
                return;
            }

            try {
                const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
                const colRef = collection(db, "artifacts", appId, "public/data/students");
                await addDoc(colRef, newStudent);
                fullNameInput.value = '';
                usernameInput.value = '';
                passwordInput.value = '';
                classInput.value = '';
                showToast('Siswa berhasil ditambahkan!');
            } catch(error) {
                console.error("Error adding student:", error);
                showToast('Gagal menambahkan siswa.', 'error');
            }
        }
        
        async function deleteStudent(studentId, studentName) {
            window.openModal('confirm', {
                message: `Anda yakin ingin menghapus akun siswa "${studentName}"? Tindakan ini tidak dapat diurungkan.`,
                onConfirm: async () => {
                    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
                    const docRef = doc(db, "artifacts", appId, "public/data/students", studentId);
                    try {
                        await deleteDoc(docRef);
                        showToast(`Akun ${studentName} berhasil dihapus.`);
                    } catch (e) {
                        showToast(`Gagal menghapus akun.`, 'error');
                    }
                }
            });
        }
        
        async function resetStudentPassword(studentId, studentName) {
            window.openModal('confirm', {
                message: `Anda yakin ingin mereset kata sandi untuk "${studentName}"? Kata sandi baru akan menjadi 'ganti123'.`,
                onConfirm: async () => {
                    const newPassword = 'ganti123';
                    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
                    const docRef = doc(db, "artifacts", appId, "public/data/students", studentId);
                    try {
                        await updateDoc(docRef, { password: newPassword });
                        showToast(`Kata sandi untuk ${studentName} direset menjadi "${newPassword}".`);
                    } catch (e) {
                        showToast(`Gagal mereset kata sandi.`, 'error');
                    }
                }
            });
        }

        async function resetCounselorPassword(counselorId, counselorName) {
            window.openModal('confirm', {
                message: `Anda yakin ingin mereset kata sandi untuk "${counselorName}"? Kata sandi baru akan menjadi 'guru123'.`,
                onConfirm: async () => {
                    const newPassword = 'guru123';
                    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
                    const docRef = doc(db, "artifacts", appId, "public/data/counselors", counselorId);
                    try {
                        await updateDoc(docRef, { password: newPassword });
                        showToast(`Kata sandi untuk ${counselorName} direset menjadi "${newPassword}".`);
                    } catch (e) {
                        showToast(`Gagal mereset kata sandi.`, 'error');
                    }
                }
            });
        }
        
        async function deleteCounselor(counselorId, counselorName) {
            window.openModal('confirm', {
                message: `Anda yakin ingin menghapus konselor "${counselorName}"?`,
                onConfirm: async () => {
                    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
                    const docRef = doc(db, "artifacts", appId, "public/data/counselors", counselorId);
                    try {
                        await deleteDoc(docRef);
                        showToast(`Konselor ${counselorName} berhasil dihapus.`);
                    } catch (e) {
                        showToast(`Gagal menghapus konselor.`, 'error');
                    }
                }
            });
        }

        async function submitKonsultasi(event) {
            event.preventDefault();
            const newKonsultasi = {
                siswaName: state.currentUser.fullName,
                kelas: document.getElementById('kelas').value,
                kategori: document.getElementById('kategori').value,
                konselorName: document.getElementById('konselor').value,
                deskripsi: document.getElementById('deskripsi').value,
                status: 'Baru',
                priority: 'Normal',
                createdAt: serverTimestamp(),
                chatHistory: [ { 
                    sender: state.currentUser.fullName, 
                    text: `[MASALAH AWAL] ${document.getElementById('deskripsi').value}`,
                    timestamp: new Date()
                } ],
                lastUpdate: serverTimestamp()
            };
            try {
                const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
                const colRef = collection(db, "artifacts", appId, "public/data/konsultasi");
                await addDoc(colRef, newKonsultasi);
                closeModal();
            } catch (error) {
                console.error("Error adding document: ", error);
                showToast('Gagal mengirim pengajuan.', 'error');
            }
        }
        
        async function sendMessage(event, konsultasiId) {
            event.preventDefault();
            const input = document.getElementById('chat-input');
            const text = input.value.trim();
            if (text) {
                const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
                const docRef = doc(db, "artifacts", appId, "public/data/konsultasi", konsultasiId);
                await updateDoc(docRef, {
                    chatHistory: arrayUnion({
                        sender: state.currentUser.fullName || state.currentUser.name,
                        text: text,
                        timestamp: new Date()
                    }),
                    lastUpdate: serverTimestamp()
                });
                input.value = '';
            }
        }

        async function updateStatus(konsultasiId, newStatus) {
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
            const docRef = doc(db, "artifacts", appId, "public/data/konsultasi", konsultasiId);
            await updateDoc(docRef, { status: newStatus });
        }


        function setupRealtimeListeners() {
            if (unsubscribeConsultations) unsubscribeConsultations();
            if (!state.currentUser) return;
            
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
            const colRef = collection(db, "artifacts", appId, "public/data/konsultasi");
            
            let q;
            if (state.currentUser.role === 'siswa') {
                q = query(colRef, where("siswaName", "==", state.currentUser.fullName));
            } else if (state.currentUser.role === 'konselor') {
                q = query(colRef, where("konselorName", "==", state.currentUser.name));
            } else if (state.currentUser.role === 'admin') {
                q = query(colRef, orderBy("createdAt", "desc"));
            } else { return; }

            unsubscribeConsultations = onSnapshot(q, (snapshot) => {
                const isInitialLoad = state.konsultasiData.length === 0;
                let consultations = [];
                snapshot.forEach(doc => {
                    consultations.push({ ...doc.data(), id: doc.id });
                });
                
                if (state.currentUser.role !== 'admin') {
                    consultations.sort((a, b) => (b.lastUpdate?.seconds || 0) - (a.lastUpdate?.seconds || 0));
                }

                if (!isInitialLoad && consultations.length > state.konsultasiData.length) {
                    state.hasNewNotification = true;
                } else if (!isInitialLoad && consultations.length > 0) {
                    const latestRemote = consultations[0];
                    const latestLocal = state.konsultasiData.find(c => c.id === latestRemote.id);
                    if (latestRemote && latestLocal && ((latestRemote.chatHistory || []).length > (latestLocal.chatHistory || []).length)) {
                        state.hasNewNotification = true;
                    }
                }

                state.konsultasiData = consultations;
                render();
            }, (error) => console.error("Error listening: ", error));
        }

        async function initFirebase() {
            try {
                console.log("Attempting to initialize Firebase...");
                const firebaseConfig = JSON.parse(window.__firebase_config || '{}');
                if (!firebaseConfig.apiKey) { 
                    console.error("Firebase config not found or is invalid.");
                    throw new Error("Firebase config not found."); 
                }
                console.log("Firebase config loaded successfully.");
                
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                onAuthStateChanged(auth, async (user) => {
                    if (!user) {
                        try {
                            const initialToken = window.__initial_auth_token;
                            if (initialToken) { await signInWithCustomToken(auth, initialToken); } 
                            else { await signInAnonymously(auth); }
                        } catch (error) { console.error("Auth failed:", error); }
                    }
                    state.isAuthReady = true;
                    
                    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
                    
                    const counselorsColRef = collection(db, "artifacts", appId, "public/data/counselors");
                    unsubscribeCounselors = onSnapshot(query(counselorsColRef, orderBy("name")), (snapshot) => {
                        state.counselors = snapshot.docs.map(doc => ({ ...doc.data(), id: doc.id }));
                        if(state.currentView === 'login_konselor' || state.currentView.startsWith('dashboard')) render();
                    });

                    const studentsColRef = collection(db, "artifacts", appId, "public/data/students");
                    unsubscribeStudents = onSnapshot(query(studentsColRef, orderBy("fullName")), snapshot => {
                        state.students = snapshot.docs.map(doc => ({ ...doc.data(), id: doc.id }));
                         if(state.currentView === 'dashboard_admin') render();
                    });
                    
                    render();
                });
            } catch (error) {
                console.error("Firebase init failed:", error);
                document.getElementById('app').innerHTML = `<div class="p-4 text-red-600 bg-red-100">Error: Gagal menginisialisasi database.</div>`;
            }
        }
        
        function logout() {
            if(unsubscribeConsultations) unsubscribeConsultations();
            state.currentUser = null;
            state.currentView = 'role_selection';
            render();
        }

        function openChat(konsultasiId) {
            state.selectedKonsultasi = konsultasiId;
            state.currentView = 'chat';
            render();
        }

        function backToDashboard() {
            state.selectedKonsultasi = null;
            state.currentView = `dashboard_${state.currentUser.role}`;
            render();
        }

        function openModal(modalType, options = {}) {
            const modalContainer = document.getElementById('modal-container');
            const modalContent = document.getElementById('modal-content');
            if (modalType === 'changePassword') {
                modalContent.innerHTML = ChangePasswordModal();
            } else if (modalType === 'formKonsultasi') {
                modalContent.innerHTML = FormKonsultasiModal();
            } else if (modalType === 'confirm') {
                modalContent.innerHTML = ConfirmationModal(options.message);
                document.getElementById('confirm-yes-btn').onclick = () => {
                    options.onConfirm();
                    closeModal();
                };
            }
            modalContainer.classList.remove('hidden');
        }

        function closeModal() {
            const modalContainer = document.getElementById('modal-container');
            modalContainer.classList.add('hidden');
            document.getElementById('modal-content').innerHTML = '';
        }
        
        function togglePasswordVisibility(inputId, iconId) {
            const passwordInput = document.getElementById(inputId);
            const icon = document.getElementById(iconId);
            if (passwordInput.type === 'password') {
                passwordInput.type = 'text';
                icon.classList.remove('fa-eye');
                icon.classList.add('fa-eye-slash');
            } else {
                passwordInput.type = 'password';
                icon.classList.remove('fa-eye-slash');
                icon.classList.add('fa-eye');
            }
        }

        function setTheme(themeName) {
            const theme = themes[themeName];
            if (!theme) return;
            for (const [key, value] of Object.entries(theme.vars)) {
                document.documentElement.style.setProperty(key, value);
            }
            state.currentTheme = themeName;
        }

        function setLanguage(lang) {
            state.currentLang = lang;
            render();
        }
        
        function navigateTo(view) {
            state.currentView = view;
            render();
        }

        window.onload = () => {
             // Attach functions to window object
            window.setTheme = setTheme;
            window.setLanguage = setLanguage;
            window.navigateTo = navigateTo;
            window.login = login;
            window.logout = logout;
            window.openChat = openChat;
            window.backToDashboard = backToDashboard;
            window.sendMessage = sendMessage;
            window.updateStatus = updateStatus;
            window.openModal = openModal;
            window.closeModal = closeModal;
            window.submitKonsultasi = submitKonsultasi;
            window.addCounselor = addCounselor;
            window.addStudent = addStudent;
            window.deleteStudent = deleteStudent;
            window.resetStudentPassword = resetStudentPassword;
            window.resetCounselorPassword = resetCounselorPassword;
            window.deleteCounselor = deleteCounselor;
            window.togglePasswordVisibility = togglePasswordVisibility;
            window.showNotification = showNotification;
            window.changePassword = changePassword;
            window.updatePriority = updatePriority;

            initFirebase();
            setTheme(state.currentTheme); 
            render();
        };
    </script>
</body>
</html>

